diff --git a/build/parsePrep.c b/build/parsePrep.c
index 3dab37f..81618e6 100644
--- a/build/parsePrep.c
+++ b/build/parsePrep.c
@@ -138,7 +138,9 @@ static char *doUntar(rpmSpec spec, uint3
     char *fn = NULL;
     char *buf = NULL;
     char *tar = NULL;
-    const char *taropts = ((rpmIsVerbose() && !quietly) ? "-xvvf" : "-xf");
+    char taropts[8];
+    char *t;
+    int rubygem = 0;
     struct Source *sp;
     rpmCompressedMagic compressed = COMPRESSED_NOT;
 
@@ -158,6 +160,17 @@ static char *doUntar(rpmSpec spec, uint3
 
     fn = rpmGetPath("%{_sourcedir}/", sp->source, NULL);
 
+     t = rindex(sp->source, '.');
+     if(t && !strcasecmp(t, ".gem"))
+        rubygem = 1;
+ 
+     t = stpcpy(taropts, "-x");
+     if(rpmIsVerbose() && !quietly)
+        t = stpcpy(t, "vv");
+     if(rubygem)
+        t = stpcpy(t, "m");
+     t = stpcpy(t, "f");
+ 
     /* XXX On non-build parse's, file cannot be stat'd or read */
     if (!(spec->flags & RPMSPEC_FORCE) && (rpmFileIsCompressed(fn, &compressed) || checkOwners(fn))) {
 	goto exit;
@@ -201,10 +214,20 @@ static char *doUntar(rpmSpec spec, uint3
 	zipper = rpmGetPath(t, NULL);
 	if (needtar) {
 	    rasprintf(&buf, "%s '%s' | %s %s - \n"
-		"STATUS=$?\n"
-		"if [ $STATUS -ne 0 ]; then\n"
-		"  exit $STATUS\n"
-		"fi", zipper, fn, tar, taropts);
+                   "STATUS=$?\n"
+                   "if [ $STATUS -ne 0 ]; then\n"
+                   "  exit $STATUS\n"
+                   "fi", zipper, fn, tar, taropts);
+           if(rubygem) {
+               t = stpcpy(t,
+                       "\n"
+                       "if [ -f data.tar.gz ]; then\n"
+                       "  tar ");
+               t = stpcpy(t, taropts);
+               t = stpcpy(t,
+                       " data.tar.gz\n"
+                       "fi");
+           }
 	} else {
 	    rasprintf(&buf, "%s '%s'\n"
 		"STATUS=$?\n"
@@ -316,6 +339,20 @@ static int doSetupMacro(rpmSpec spec, co
 	free(buf);
     }
 
+    /* check if source is a ruby gem */
+    {   struct Source *sp;
+       for (sp = spec->sources; sp != NULL; sp = sp->next) {
+           if ((sp->flags & RPMBUILD_ISSOURCE) && (sp->num == 0)) {
+               break;
+           }
+       }
+       if (sp != NULL) {
+           char *t = rindex(sp->source, '.');
+           if(t && !strcasecmp(t, ".gem"))
+               createDir = 1;
+       }
+    }
+
     /* if necessary, create and cd into the proper dir */
     if (createDir) {
 	buf = rpmExpand("%{__mkdir_p} ", spec->buildSubdir, "\n",
